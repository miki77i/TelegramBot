import logging
import sqlite3
from datetime import datetime

from telegram import (
    Update,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    InputMediaPhoto,
)
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ConversationHandler,
    ContextTypes,
    CallbackQueryHandler,
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', 
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π ConversationHandler
(
    CHOOSE_GENDER,
    ENTER_AGE,
    ENTER_ABOUT,
    CHOOSE_TARGET_GENDER,
    ENTER_AGE_RANGE,
    UPLOAD_PHOTO,
    EDIT_CHOOSE_FIELD,
    EDIT_FIELD,
    REVIEW_ENTER_TARGET,
    REVIEW_ENTER_TEXT,
) = range(10)

# –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DATABASE_FILE = 'database'

class Database:
    def __init__(self, db_file=DATABASE_FILE):
        self.db_file = db_file
        self._initialize_db()

    def _initialize_db(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü"""
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            
            # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    user_id INTEGER PRIMARY KEY,
                    username TEXT,
                    first_name TEXT,
                    last_name TEXT,
                    gender TEXT,
                    age INTEGER,
                    about TEXT,
                    target_gender TEXT,
                    age_min INTEGER,
                    age_max INTEGER,
                    photo_id TEXT
                    
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –ª–∞–π–∫–æ–≤
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS likes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    from_user_id INTEGER,
                    to_user_id INTEGER,
                    UNIQUE(from_user_id, to_user_id))
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–∑—ã–≤–æ–≤
           # cursor.execute('''
            #    CREATE TABLE IF NOT EXISTS reviews (
             #       id INTEGER PRIMARY KEY AUTOINCREMENT,
              #      target_username TEXT NOT NULL,
               #     text TEXT NOT NULL
                #)
            #''')
            
            #conn.commit()

    def add_user(self, user_id, username, first_name, last_name):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT OR IGNORE INTO users (user_id, username, first_name, last_name)
                VALUES (?, ?, ?, ?)
            ''', (user_id, username, first_name, last_name))
            conn.commit()

    def get_user(self, user_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        with sqlite3.connect(self.db_file) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
            return cursor.fetchone()

    def update_user(self, user_id, **fields):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if not fields:
            return
            
        set_clause = ', '.join([f"{key} = ?" for key in fields.keys()])
        values = list(fields.values())
        values.append(user_id)
        
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            cursor.execute(f'''
                UPDATE users SET {set_clause} WHERE user_id = ?
            ''', values)
            conn.commit()

    def get_all_users(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        with sqlite3.connect(self.db_file) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute('SELECT * FROM users')
            return cursor.fetchall()

    def add_like(self, from_user_id, to_user_id):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∞–π–∫–∞"""
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            try:
                cursor.execute('''
                    INSERT INTO likes (from_user_id, to_user_id)
                    VALUES (?, ?)
                ''', (from_user_id, to_user_id))
                conn.commit()
                return True
            except sqlite3.IntegrityError:
                return False

    def check_mutual_like(self, user1_id, user2_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∑–∞–∏–º–Ω–æ–≥–æ –ª–∞–π–∫–∞"""
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT COUNT(*) FROM likes
                WHERE (from_user_id = ? AND to_user_id = ?)
                OR (from_user_id = ? AND to_user_id = ?)
            ''', (user1_id, user2_id, user2_id, user1_id))
            return cursor.fetchone()[0] == 2

    def add_review(self, target_username, text):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞"""
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO reviews (target_username, text)
                VALUES (?, ?)
            ''', (target_username.lower(), text))
            conn.commit()

    def get_reviews(self, username):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        with sqlite3.connect(self.db_file) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT text FROM reviews
                WHERE target_username = ?
                
            ''', (username.lower(),))
            return [row[0] for row in cursor.fetchall()]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db = Database()

# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---

async def main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["–°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∫–µ—Ç—É", "–ò—Å–∫–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞"],
        ["–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å", "–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤"],
        ["–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    if update.message:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)
    elif update.callback_query:
        await update.callback_query.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    db.add_user(user.id, user.username, user.first_name, user.last_name)
    await main_menu(update, context)

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()
    
    if text == "—Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∫–µ—Ç—É":
        reply_keyboard = [['–ú—É–∂—Å–∫–æ–π', '–ñ–µ–Ω—Å–∫–∏–π', '–î—Ä—É–≥–æ–π']]
        await update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø–æ–ª:",
            reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
        )
        return CHOOSE_GENDER
        
    elif text == "–∏—Å–∫–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞":
        return await search(update, context)
        
    elif text == "—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å":
        return await edit_profile(update, context)
        
    elif text == "–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤":
        await update.message.reply_text(
            "–ü–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.",
           reply_markup=ReplyKeyboardRemove()
        )
        return main_menu
        
    elif text == "–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã":
        return await show_reviews(update, context)
        
    else:
        await main_menu(update, context)
        return ConversationHandler.END

# --- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã ---

async def choose_gender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    gender = update.message.text.lower()
    if gender not in ['–º—É–∂—Å–∫–æ–π', '–∂–µ–Ω—Å–∫–∏–π', '–¥—Ä—É–≥–æ–π']:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –ø–æ–ª –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")
        return CHOOSE_GENDER
        
    context.user_data['gender'] = gender.capitalize()
    await update.message.reply_text("–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?", reply_markup=ReplyKeyboardRemove())
    return ENTER_AGE

async def enter_age(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        age = int(update.message.text)
        if age < 13 or age > 120:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–æ—Ç 13 –¥–æ 120).")
            return ENTER_AGE
    except ValueError:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —á–∏—Å–ª–æ.")
        return ENTER_AGE
        
    context.user_data['age'] = age
    await update.message.reply_text("–†–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤):")
    return ENTER_ABOUT

async def enter_about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    about = update.message.text
    context.user_data['about'] = about
    reply_keyboard = [['–ú—É–∂—Å–∫–æ–π', '–ñ–µ–Ω—Å–∫–∏–π', '–õ—é–±–æ–π']]
    await update.message.reply_text(
        "–ö–∞–∫–æ–π –ø–æ–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Ç—ã –∏—â–µ—à—å?",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
    )
    return CHOOSE_TARGET_GENDER

async def choose_target_gender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    target_gender = update.message.text.lower()
    if target_gender not in ['–º—É–∂—Å–∫–æ–π', '–∂–µ–Ω—Å–∫–∏–π', '–ª—é–±–æ–π']:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –ø–æ–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")
        return CHOOSE_TARGET_GENDER
        
    context.user_data['target_gender'] = target_gender.capitalize()
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∏—Å–∫–æ–º–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20-30):",
        reply_markup=ReplyKeyboardRemove(),
    )
    return ENTER_AGE_RANGE

async def enter_age_range(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    try:
        parts = text.split('-')
        if len(parts) != 2:
            raise ValueError
        age_min = int(parts[0])
        age_max = int(parts[1])
        if not (13 <= age_min <= age_max <= 120):
            raise ValueError
    except ValueError:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 20-30")
        return ENTER_AGE_RANGE
        
    context.user_data['age_min'] = age_min
    context.user_data['age_max'] = age_max
    await update.message.reply_text(
        "–û—Ç–ø—Ä–∞–≤—å —Å–≤–æ–µ —Ñ–æ—Ç–æ (–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç, –∞ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ) –∏–ª–∏ –Ω–∞–∂–º–∏ /skip —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å:"
    )
    return UPLOAD_PHOTO

async def upload_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.photo:
        photo = update.message.photo[-1]
        context.user_data['photo_id'] = photo.file_id
    else:
        context.user_data['photo_id'] = None

    user_id = update.message.from_user.id
    username = update.message.from_user.username
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
    db.update_user(user_id, **context.user_data)
    
    if username:
        db.update_user(user_id, username=username)

    await update.message.reply_text(
        "–ê–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞! –¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –∏—Å–∫–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤.",
        reply_markup=ReplyKeyboardRemove()
    )
    await main_menu(update, context)
    return ConversationHandler.END

async def skip_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['photo_id'] = None
    return await upload_photo(update, context)

# --- –ü–æ–∏—Å–∫ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∫–µ—Ç ---

async def show_profile(update_obj, context, profiles, index):
    if index >= len(profiles):
        if hasattr(update_obj, 'callback_query'):
            await update_obj.callback_query.edit_message_text("–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.")
        else:
            await update_obj.message.reply_text("–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.")
        return

    profile = dict(profiles[index])
    username = profile.get('username', '–Ω–µ —É–∫–∞–∑–∞–Ω')
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–∑—ã–≤—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_reviews = db.get_reviews(username) if username and username != '–Ω–µ —É–∫–∞–∑–∞–Ω' else []
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç—ã
    text = (
        f"üë§ {profile.get('first_name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')} {profile.get('last_name', '')}\n"
        f"–ü–æ–ª: {profile.get('gender', '–Ω–µ —É–∫–∞–∑–∞–Ω')}\n"
        f"–í–æ–∑—Ä–∞—Å—Ç: {profile.get('age', '–Ω–µ —É–∫–∞–∑–∞–Ω')}\n"
        f"–û —Å–µ–±–µ: {profile.get('about', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if user_reviews:
        text += "\nüìù –û—Ç–∑—ã–≤—ã:\n"
        for i, review in enumerate(user_reviews[:3], 1):
            text += f"{i}. {review}\n"
        if len(user_reviews) > 3:
            text += f"... –∏ –µ—â—ë {len(user_reviews)-3} –æ—Ç–∑—ã–≤–æ–≤\n"
    
    keyboard = [
        [
            InlineKeyboardButton("üëç –ù—Ä–∞–≤–∏—Ç—Å—è", callback_data=f"like_{index}"),
            InlineKeyboardButton("‚û°Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data=f"skip_{index}")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    if profile.get('photo_id'):
        if hasattr(update_obj, 'callback_query'):
            await update_obj.callback_query.edit_message_media(
                media=InputMediaPhoto(profile['photo_id'], caption=text),
                reply_markup=reply_markup
            )
        else:
            await update_obj.message.reply_photo(
                photo=profile['photo_id'],
                caption=text,
                reply_markup=reply_markup
            )
    else:
    #     if hasattr(update_obj, 'callback_query'):
    #         await update_obj.callback_query.edit_message_text(text, reply_markup=reply_markup)
    #     else:
        await update_obj.message.reply_text(text, reply_markup=reply_markup)

async def search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user = db.get_user(user_id)
    if not user:
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∞–Ω–∫–µ—Ç—É.")
        return ConversationHandler.END
    
    all_users = db.get_all_users()
    results = [
        u for u in all_users
        if u['user_id'] != user_id and
           (user['target_gender'].lower() == '–ª—é–±–æ–π' or u['gender'].lower() == user['target_gender'].lower()) and
           (user['age_min'] <= u['age'] <= user['age_max'])
    ]
    
    if not results:
        await update.message.reply_text("–ü–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        return ConversationHandler.END
    
    context.user_data['search_results'] = results
    context.user_data['search_index'] = 0
    await show_profile(update, context, results, 0)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    index = context.user_data.get('search_index', 0)
    results = context.user_data.get('search_results', [])
    
    if not results:
        await query.edit_message_text("–ù–µ—Ç –∞–Ω–∫–µ—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞.")
        return

    if data.startswith("like_"):
        liked_index = int(data.split('_')[1])
        liked_user = results[liked_index]
        liker_id = query.from_user.id
        liked_id = liked_user['user_id']

        db.add_like(liker_id, liked_id)
        await query.answer("–í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∞–π–∫!")

        if db.check_mutual_like(liker_id, liked_id):
            liker = db.get_user(liker_id)
            liked = db.get_user(liked_id)
            
            if liker and liked:
                liker_name = liker['username'] or f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {liker_id}"
                liked_name = liked['username'] or f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {liked_id}"

                try:
                    await context.bot.send_message(
                        chat_id=liker_id,
                        text=f"–£ –≤–∞—Å –≤–∑–∞–∏–º–Ω—ã–π –ª–∞–π–∫ —Å @{liked_name}!\n"
                             f"–ü–æ–ª: {liked['gender']}\n"
                             f"–í–æ–∑—Ä–∞—Å—Ç: {liked['age']}\n"
                             f"–û —Å–µ–±–µ: {liked['about']}\n"
                             f"Telegram: @{liked['username']}"

                    )
                    await context.bot.send_message(
                        chat_id=liked_id,
                        text=f"–£ –≤–∞—Å –≤–∑–∞–∏–º–Ω—ã–π –ª–∞–π–∫ —Å @{liker_name}!\n"
                             f"–ü–æ–ª: {liker['gender']}\n"
                             f"–í–æ–∑—Ä–∞—Å—Ç: {liker['age']}\n"
                             f"–û —Å–µ–±–µ: {liker['about']}\n"
                             f"Telegram: @{liker['username']}"
                    )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

        index = liked_index + 1
        if index < len(results):
            context.user_data['search_index'] = index
            await show_profile(query, context, results, index)
        else:
            await query.edit_message_text("–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.")

    elif data.startswith("skip_"):
        index = int(data.split('_')[1]) + 1
        if index < len(results):
            context.user_data['search_index'] = index
            await show_profile(query, context, results, index)
        else:
            await query.edit_message_text("–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.")

# --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è ---

async def edit_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = db.get_user(update.message.from_user.id)
    if not user:
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∞–Ω–∫–µ—Ç—É.")
        return ConversationHandler.END
        
    reply_keyboard = [
        ['–ü–æ–ª', '–í–æ–∑—Ä–∞—Å—Ç'],
        ['–û —Å–µ–±–µ', '–ò—Å–∫–æ–º—ã–π –ø–æ–ª'],
        ['–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω', '–§–æ—Ç–æ'],
        ['–û—Ç–º–µ–Ω–∞']
    ]
    await update.message.reply_text(
        "–ß—Ç–æ —Ö–æ—á–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å?",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True)
    )
    return EDIT_CHOOSE_FIELD

async def edit_choose_field(update: Update, context: ContextTypes.DEFAULT_TYPE):
    choice = update.message.text.lower()
    if choice == '–æ—Ç–º–µ–Ω–∞':
        await update.message.reply_text("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=ReplyKeyboardRemove())
        return ConversationHandler.END
        
    fields_map = {
        '–ø–æ–ª': 'gender',
        '–≤–æ–∑—Ä–∞—Å—Ç': 'age',
        '–æ —Å–µ–±–µ': 'about',
        '–∏—Å–∫–æ–º—ã–π –ø–æ–ª': 'target_gender',
        '–≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω': 'age_range',
        '—Ñ–æ—Ç–æ': 'photo'
    }
    
    if choice not in fields_map:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –ø–æ–ª–µ –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return EDIT_CHOOSE_FIELD
        
    context.user_data['edit_field'] = fields_map[choice]
    field = fields_map[choice]
    
    if field == 'age_range':
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20-30):")
    elif field == 'gender':
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –ø–æ–ª: –ú—É–∂—Å–∫–æ–π, –ñ–µ–Ω—Å–∫–∏–π, –î—Ä—É–≥–æ–π")
    elif field == 'target_gender':
        await update.message.reply_text("–ö–∞–∫–æ–π –ø–æ–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤—ã –∏—â–µ—Ç–µ? –ú—É–∂—Å–∫–æ–π, –ñ–µ–Ω—Å–∫–∏–π, –õ—é–±–æ–π")
    elif field == 'age':
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç:")
    elif field == 'about':
        await update.message.reply_text("–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ:")
    elif field == 'photo':
        await update.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ /skip —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ:")
        return EDIT_FIELD
        
    return EDIT_FIELD

async def edit_field(update: Update, context: ContextTypes.DEFAULT_TYPE):
    field = context.user_data.get('edit_field')
    user_id = update.message.from_user.id
    update_data = {}

    if field == 'photo':
        if update.message.photo:
            photo = update.message.photo[-1]
            update_data['photo_id'] = photo.file_id
        else:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /skip")
            return EDIT_FIELD
    else:
        text = update.message.text.strip()
        text_lower = text.lower()
        
        if field == 'gender':
            if text_lower not in ['–º—É–∂—Å–∫–æ–π', '–∂–µ–Ω—Å–∫–∏–π', '–¥—Ä—É–≥–æ–π']:
                await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ: –ú—É–∂—Å–∫–æ–π, –ñ–µ–Ω—Å–∫–∏–π –∏–ª–∏ –î—Ä—É–≥–æ–π")
                return EDIT_FIELD
            update_data['gender'] = text.capitalize()
            
        elif field == 'target_gender':
            if text_lower not in ['–º—É–∂—Å–∫–æ–π', '–∂–µ–Ω—Å–∫–∏–π', '–ª—é–±–æ–π']:
                await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ: –ú—É–∂—Å–∫–æ–π, –ñ–µ–Ω—Å–∫–∏–π –∏–ª–∏ –õ—é–±–æ–π")
                return EDIT_FIELD
            update_data['target_gender'] = text.capitalize()
            
        elif field == 'age':
            try:
                age = int(text)
                if age < 13 or age > 120:
                    raise ValueError
                update_data['age'] = age
            except ValueError:
                await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–æ—Ç 13 –¥–æ 120):")
                return EDIT_FIELD
                
        elif field == 'about':
            update_data['about'] = text
            
        elif field == 'age_range':
            try:
                parts = text.split('-')
                if len(parts) != 2:
                    raise ValueError
                age_min = int(parts[0])
                age_max = int(parts[1])
                if not (13 <= age_min <= age_max <= 120):
                    raise ValueError
                update_data['age_min'] = age_min
                update_data['age_max'] = age_max
            except ValueError:
                await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 20-30")
                return EDIT_FIELD

    db.update_user(user_id, **update_data)
    await update.message.reply_text("–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!", reply_markup=ReplyKeyboardRemove())
    await main_menu(update, context)
    return ConversationHandler.END

async def skip_photo_edit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    db.update_user(user_id, photo_id=None)
    await update.message.reply_text("–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è!", reply_markup=ReplyKeyboardRemove())
    await main_menu(update, context)
    return ConversationHandler.END

# --- –û—Ç–∑—ã–≤—ã ---

async def review_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @username):",
        reply_markup=ReplyKeyboardRemove()
    )
    return REVIEW_ENTER_TARGET

# async def review_enter_target(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     username = update.message.text.strip()
#     if not username.startswith('@'):
#         username = '@' + username
        
#     context.user_data['review_target'] = username
#     await update.message.reply_text(f"–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ –¥–ª—è {username}:")
#     return REVIEW_ENTER_TEXT

# async def review_enter_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     text = update.message.text.strip()
#     username = context.user_data.get('review_target')
    
#     if not username:
#         await update.message.reply_text("–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.")
#         return ConversationHandler.END
    
#     if len(text) > 100:
#         await update.message.reply_text("–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ—Ä–æ—á–µ:")
#         return REVIEW_ENTER_TEXT
    
    # author_id = update.message.from_user.id
    # print(f"–î–∞–Ω–Ω—ã–µ: username={username}, text={text}")
    # db.add_review(username, text)
    
    # await update.message.reply_text("–í–∞—à –æ—Ç–∑—ã–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!")
    # await main_menu(update, context)
    # return ConversationHandler.END

async def show_reviews(update: Update, context: ContextTypes.DEFAULT_TYPE):
    username = update.message.from_user.username
    if not username:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç username, –æ—Ç–∑—ã–≤—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.")
        await main_menu(update, context)
        return
    
    user_reviews = db.get_reviews(username)
    
    if not user_reviews:
        await update.message.reply_text("–û—Ç–∑—ã–≤–æ–≤ –æ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç.")
    else:
        response = "üìù –û—Ç–∑—ã–≤—ã –æ –≤–∞—Å:\n\n"
        for i, review in enumerate(user_reviews, 1):
            response += f"{i}. {review}\n"
        await update.message.reply_text(response)
    
    await main_menu(update, context)
    return ConversationHandler.END

# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---

def main():
    application = Application.builder().token("8121277507:AAEvqSpC30D6kQzU1-ACkDgJ5FLomy7DKnc").build()

    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler("start", start),
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_menu),
        ],
        states={
            CHOOSE_GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, choose_gender)],
            ENTER_AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, enter_age)],
            ENTER_ABOUT: [MessageHandler(filters.TEXT & ~filters.COMMAND, enter_about)],
            CHOOSE_TARGET_GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, choose_target_gender)],
            ENTER_AGE_RANGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, enter_age_range)],
            UPLOAD_PHOTO: [
                MessageHandler(filters.PHOTO, upload_photo),
                CommandHandler("skip", skip_photo)
            ],
            EDIT_CHOOSE_FIELD: [MessageHandler(filters.TEXT & ~filters.COMMAND, edit_choose_field)],
            EDIT_FIELD: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, edit_field),
                MessageHandler(filters.PHOTO, edit_field),
                CommandHandler("skip", skip_photo_edit)
            ],
            # REVIEW_ENTER_TARGET: [MessageHandler(filters.TEXT & ~filters.COMMAND, review_enter_target)],
            # REVIEW_ENTER_TEXT: [MessageHandler(filters.TEXT & ~filters.COMMAND, review_enter_text)],
        },
        fallbacks=[CommandHandler("start", start)],
    )

    application.add_handler(conv_handler)
    application.add_handler(CallbackQueryHandler(button_handler))

    application.run_polling()

if __name__ == "__main__":
    main()
